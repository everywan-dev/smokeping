# SmokePing Docker - Traefik + Swarm Deployment
# No requiere nginx - Traefik maneja el routing directamente
#
# Uso:
#   docker stack deploy -c docker-compose.swarm.yml smokeping

version: '3.8'

services:
  smokeping:
    image: sistemasminorisa/smokeping:2.9.0
    hostname: ${SMOKEPING_HOSTNAME:-smokeping-master}
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Madrid}
      
      # Identidad del Sitio
      - SMOKEPING_OWNER=${SMOKEPING_OWNER:-everyWAN NOC}
      - SMOKEPING_CONTACT=${SMOKEPING_CONTACT:-soporte@everywan.com}
      - SMOKEPING_HOSTNAME=${SMOKEPING_HOSTNAME:-smokeping-master}
      - SMOKEPING_TITLE=${SMOKEPING_TITLE:-everyWAN Network Monitor}
      
      # Personalización Visual
      - SMOKEPING_BRAND_NAME=${SMOKEPING_BRAND_NAME:-everyWAN}
      - SMOKEPING_BRAND_URL=${SMOKEPING_BRAND_URL:-https://everywan.com}
      - SMOKEPING_LOGO_URL=${SMOKEPING_LOGO_URL:-https://as33932.net/logos/svg_blanco.svg}
      - SMOKEPING_COLOR_SIDEBAR_BG=#233350
      
      # Configuración Traceroute
      - TRACEPING_INTERVAL=${TRACEPING_INTERVAL:-300}
      - TRACEPING_RETENTION_DAYS=${TRACEPING_RETENTION_DAYS:-365}
      
    # Capabilities for ping/traceroute
    cap_add:
      - NET_RAW
      - NET_ADMIN
      
    volumes:
      - ./config:/config
      - ./data:/data
      - ./logs:/logs

    # --------------------------------------------------------------------------
    # MODO 1: STANDALONE O SWARM SIN PROXY (Directo al puerto 80)
    # --------------------------------------------------------------------------
    # Descomenta esto si NO usas Traefik y quieres acceder directo por IP:Puerto
    ports:
      - "80:80"

    # --------------------------------------------------------------------------
    # MODO 2: DEPLOY CONFIG (SWARM)
    # --------------------------------------------------------------------------
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      
      # ------------------------------------------------------------------------
      # CONFIGURACIÓN TRAEFIK (Opcional - Descomentar para activar)
      # ------------------------------------------------------------------------
      # labels:
      #   - "traefik.enable=true"
      #   - "traefik.http.routers.smokeping.rule=Host(`smokeping.example.com`)"
      #   - "traefik.http.routers.smokeping.entrypoints=websecure"
      #   - "traefik.http.routers.smokeping.tls=true"
      #   - "traefik.http.routers.smokeping.service=smokeping-svc"
      #   - "traefik.http.services.smokeping-svc.loadbalancer.server.port=80"
      #   # Middleware para redirección slash
      #   - "traefik.http.middlewares.smokeping-slash.redirectregex.regex=^https?://([^/]+)/smokeping$$"
      #   - "traefik.http.middlewares.smokeping-slash.redirectregex.replacement=https://$${1}/smokeping/"
      #   - "traefik.http.routers.smokeping.middlewares=smokeping-slash"

    # networks:
    #   - traefik-public

# networks:
#   traefik-public:
#     external: true
