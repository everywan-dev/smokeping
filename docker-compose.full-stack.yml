version: '3.8'

services:
  # ==========================================
  # Traefik Reverse Proxy (The Gateway)
  # ==========================================
  traefik:
    image: traefik:v3.3
    hostname: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - monitor-net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  # ==========================================
  # Smokeping Application
  # ==========================================
  smokeping:
    image: sistemasminorisa/smokeping:2.9.0
    container_name: smokeping
    hostname: ${SMOKEPING_HOSTNAME:-smokeping}
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Madrid}
      - SMOKEPING_OWNER=${SMOKEPING_OWNER:-SmokePing Admin}
      - SMOKEPING_CONTACT=${SMOKEPING_CONTACT:-admin@example.com}
      - SMOKEPING_HOSTNAME=${SMOKEPING_HOSTNAME:-smokeping}
      - SMOKEPING_TITLE=${SMOKEPING_TITLE:-Network Monitor}
      - SMOKEPING_BRAND_NAME=${SMOKEPING_BRAND_NAME:-My Company}
      - SMOKEPING_BRAND_URL=${SMOKEPING_BRAND_URL:-https://example.com}
      - SMOKEPING_LOGO_URL=${SMOKEPING_LOGO_URL:-images/smokeping.png}
      - SMOKEPING_COLOR_SIDEBAR_BG=${SMOKEPING_COLOR_SIDEBAR_BG:-#1a1a2e}
      - TRACEPING_INTERVAL=${TRACEPING_INTERVAL:-300}
      - TRACEPING_RETENTION_DAYS=${TRACEPING_RETENTION_DAYS:-365}
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - ./config:/config
      - ./data:/data
      - ./logs:/logs
    networks:
      - monitor-net
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.smokeping.rule=Host(`localhost`) || HostRegexp(`^.+`)"
        - "traefik.http.routers.smokeping.entrypoints=web"
        - "traefik.http.services.smokeping.loadbalancer.server.port=80"

networks:
  monitor-net:
    driver: overlay
